"0","## age-specific analysis "
"0","numident_sample <- numident_sample %>% "
"0","  mutate(years_apart_categories = case_when("
"0","    year_cycle_last - year_cycle_first < 5 ~ 0,"
"0","    year_cycle_last - year_cycle_first >= 5 ~ 1"
"0","  )) %>% "
"0","  mutate(age_at_last_app = year_cycle_last - byear)"
"0",""
"0","## calculate totals by sample "
"0","totals <- numident_sample %>% "
"0","  group_by(race_first, age_at_last_app) %>% "
"0","  tally() %>% "
"0","  rename(population = n)"
"0",""
"0","switchers <- numident_sample %>% "
"0","  group_by(race_first, age_at_last_app) %>% "
"0","  filter(race_first != race_last) %>% "
"0","  tally() %>% "
"0","  rename(switched_race = n)"
"0",""
"0","change_by_group <- totals %>% "
"0","  inner_join(switchers) %>% "
"0","  mutate(no_race_change = (population-switched_race)/(population))"
"2","Joining, by = c(""race_first"", ""age_at_last_app"")"
"0","change_by_age <- change_by_group %>% "
"0","  filter(age_at_last_app > 20 & age_at_last_app < 85) %>% "
"0","  mutate(category = case_when("
"0","    race_first == 4 ~ ""Asian"","
"0","    race_first == 1 ~ ""White"","
"0","    race_first == 2 ~ ""Black"","
"0","    race_first == 5 ~ ""Hispanic"","
"0","    race_first == 6 ~ ""American Indian"","
"0","    TRUE ~ ""other"")) %>% "
"0","  filter(category != ""other"") %>% "
"0","  mutate(label = if_else(age_at_last_app == max(age_at_last_app), as.character(category), NA_character_)) %>%"
"0","ggplot(aes(x = age_at_last_app, y = no_race_change, group = category, color = category))+ "
"0","  geom_line(size = 1.5) +"
"0","  theme_minimal(base_size = 25) +"
"0","  theme(legend.position=""bottom"") +"
"0","  labs(title = """","
"0","       x = ""Age"", "
"0","       y = ""Stayed in Category"") + "
"0","  geom_label_repel(aes(label = label),"
"0","                  nudge_x = 5,"
"0","                  na.rm = TRUE, size = 5, "
"0","                  xlim = c(60, 85)) + "
"0","  scale_y_continuous(limits = c(0.5, 1), labels = scales::percent) + "
"0","  scale_color_viridis_d(guide = FALSE, end = 1)"
"0",""
"0","ggsave(plot = change_by_age, filename = here(""figures/race_change_by_age.png""), height = 10, width = 12)"
